from linebot.models import FlexSendMessage, MessageEvent, TextSendMessage
from linebot.exceptions import InvalidSignatureError
from linebot.aiohttp_async_http_client import AiohttpAsyncHttpClient
from linebot import AsyncLineBotApi, WebhookParser
from fastapi import Request, FastAPI, HTTPException
import logging
import cv2
import re
import aiohttp
import numpy as np
import os
import sys
import tempfile
from dotenv import load_dotenv
from tensorflow.keras.models import load_model
from PIL import Image
from io import BytesIO
from sklearn.preprocessing import LabelEncoder

from linebot.models import MessageEvent, TextMessage, TextSendMessage, ImageMessage



# à¹‚à¸«à¸¥à¸”à¸•à¸±à¸§à¹à¸›à¸£ environment
load_dotenv()




# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[logging.StreamHandler(sys.stdout)]
)

# à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸•à¸±à¸§à¹à¸›à¸£ environment
channel_secret = os.getenv('ChannelSecret')
channel_access_token = os.getenv('ChannelAccessToken')



if not channel_secret or not channel_access_token:
    logging.error("Missing LINE channel credentials")
    sys.exit(1)

# à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥ Keras
try:
    model = load_model('model_final_1.h5')
    logging.info("Model loaded successfully")
except Exception as e:
    logging.error(f"Error loading model: {e}")
    sys.exit(1)





# à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸£à¸„à¹ƒà¸šà¸­à¹‰à¸­à¸¢ (à¸£à¸§à¸¡à¸„à¸¥à¸²à¸ª Unknown)
disease_info = {
      "Healthy": """
ðŸŒ¿ à¸­à¹‰à¸­à¸¢à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸”à¸µ

âœ… à¸¥à¸±à¸à¸©à¸“à¸°à¸‚à¸­à¸‡à¸­à¹‰à¸­à¸¢à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸”à¸µ
- à¹ƒà¸šà¸¡à¸µà¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸ªà¸”à¹ƒà¸ª à¸ªà¸¡à¹ˆà¸³à¹€à¸ªà¸¡à¸­  
- à¸¥à¸³à¸•à¹‰à¸™à¹à¸‚à¹‡à¸‡à¹à¸£à¸‡ à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸­à¸¢à¹à¸•à¸à¸«à¸£à¸·à¸­à¸ˆà¸¸à¸”à¸œà¸´à¸”à¸›à¸à¸•à¸´  
- à¸à¸²à¸£à¹€à¸ˆà¸£à¸´à¸à¹€à¸•à¸´à¸šà¹‚à¸•à¹€à¸›à¹‡à¸™à¹„à¸›à¸•à¸²à¸¡à¸›à¸à¸•à¸´  

ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸”à¸¹à¹à¸¥à¸£à¸±à¸à¸©à¸²
- à¹ƒà¸«à¹‰à¸™à¹‰à¸³à¹à¸¥à¸°à¸›à¸¸à¹‹à¸¢à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡  
- à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸›à¸¥à¸‡à¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¸ˆà¸³  
- à¸à¸³à¸ˆà¸±à¸”à¸§à¸±à¸Šà¸žà¸·à¸Šà¹à¸¥à¸°à¸¨à¸±à¸•à¸£à¸¹à¸žà¸·à¸Š  
    """,
    "Mosaic": """
ðŸŒ¿ à¹‚à¸£à¸„à¹ƒà¸šà¸”à¹ˆà¸²à¸‡à¸­à¹‰à¸­à¸¢ 

âš ï¸ à¸­à¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¹‚à¸£à¸„
- à¹ƒà¸šà¸­à¹‰à¸­à¸¢à¸¡à¸µà¸¥à¸²à¸¢à¸”à¹ˆà¸²à¸‡à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸­à¹ˆà¸­à¸™à¸ªà¸¥à¸±à¸šà¹€à¸‚à¸µà¸¢à¸§à¹€à¸‚à¹‰à¸¡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡  
- à¹ƒà¸šà¸­à¸²à¸ˆà¸šà¸´à¸”à¹€à¸šà¸µà¹‰à¸¢à¸§à¸«à¸£à¸·à¸­à¹€à¸ˆà¸£à¸´à¸à¹€à¸•à¸´à¸šà¹‚à¸•à¸Šà¹‰à¸²à¸à¸§à¹ˆà¸²à¸›à¸à¸•à¸´  
- à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸£à¸¸à¸™à¹à¸£à¸‡à¸­à¸²à¸ˆà¹à¸„à¸£à¸°à¹à¸à¸£à¹‡à¸™ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸œà¸¥à¸œà¸¥à¸´à¸•à¸•à¹ˆà¸³  

ðŸ”Ž à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹‚à¸£à¸„ 
- à¹€à¸à¸´à¸”à¸ˆà¸²à¸ à¹€à¸Šà¸·à¹‰à¸­à¹„à¸§à¸£à¸±à¸ª Sugarcane Mosaic Virus (SCMV)
- à¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¹ˆà¸²à¸™ à¹€à¸žà¸¥à¸µà¹‰à¸¢à¸­à¹ˆà¸­à¸™ (Aphids) à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸žà¸²à¸«à¸°  
- à¹à¸žà¸£à¹ˆà¸à¸£à¸°à¸ˆà¸²à¸¢à¸œà¹ˆà¸²à¸™à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸•à¸´à¸”à¹€à¸Šà¸·à¹‰à¸­  

ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸£à¸„  
- à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸•à¹‰à¸²à¸™à¸—à¸²à¸™à¹‚à¸£à¸„ à¹€à¸Šà¹ˆà¸™ KK3, LK92-11 
- à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸žà¸¥à¸µà¹‰à¸¢à¸­à¹ˆà¸­à¸™à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸ªà¸²à¸£à¸Šà¸µà¸§à¸ à¸±à¸“à¸‘à¹Œ  
- à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸ˆà¸²à¸à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸µà¹‚à¸£à¸„à¸£à¸°à¸šà¸²à¸”  

ðŸ’Š à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰
- à¸­à¸´à¸¡à¸´à¸”à¸²à¸„à¸¥à¸­à¸žà¸£à¸´à¸” (Imidacloprid)
- à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² Beauveria bassiana  

ðŸŒ± à¸£à¸°à¸¢à¸°à¹à¸£à¸à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸­à¸‡à¹‚à¸£à¸„
- à¸žà¸šà¸­à¸²à¸à¸²à¸£à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡ à¸•à¹‰à¸™à¸­à¹‰à¸­à¸¢à¸­à¸²à¸¢à¸¸ 1-2 à¹€à¸”à¸·à¸­à¸™
- à¹ƒà¸šà¹€à¸£à¸´à¹ˆà¸¡à¸¡à¸µà¸ˆà¸¸à¸”à¸”à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¹à¸–à¸šà¸„à¸¥à¹‰à¸²à¸¢à¸¥à¸²à¸¢à¹‚à¸¡à¹€à¸ªà¸„  

ðŸ“ƒ à¹à¸«à¸¥à¹ˆà¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡:
- [à¸à¸£à¸¡à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¹€à¸à¸©à¸•à¸£](https://www.doa.go.th)  
- [à¸§à¸²à¸£à¸ªà¸²à¸£à¹‚à¸£à¸„à¸žà¸·à¸Šà¹à¸¥à¸°à¸ˆà¸¸à¸¥à¸Šà¸µà¸§à¸§à¸´à¸—à¸¢à¸²](https://www.tjpp.org)  
    """,
    "Rust": """
ðŸŒ¿ à¹‚à¸£à¸„à¸£à¸²à¸ªà¸™à¸´à¸¡ (Rust Disease)

âš ï¸ à¸­à¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¹‚à¸£à¸„  
- à¸¡à¸µà¸ˆà¸¸à¸”à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¸«à¸£à¸·à¸­à¸ªà¹‰à¸¡à¸à¸£à¸°à¸ˆà¸²à¸¢à¸—à¸±à¹ˆà¸§à¹ƒà¸š  
- à¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹€à¸«à¸¥à¸·à¸­à¸‡à¹à¸¥à¸°à¹à¸«à¹‰à¸‡à¸à¹ˆà¸­à¸™à¹€à¸§à¸¥à¸²  
- à¸žà¸šà¹€à¸Šà¸·à¹‰à¸­à¸£à¸²à¸¥à¸°à¸­à¸­à¸‡à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¸„à¸¥à¹‰à¸²à¸¢à¸ªà¸™à¸´à¸¡  

ðŸ”Ž à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹‚à¸£à¸„
- à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² Puccinia kuehnii 
- à¹à¸žà¸£à¹ˆà¸à¸£à¸°à¸ˆà¸²à¸¢à¸œà¹ˆà¸²à¸™à¸¥à¸¡à¹à¸¥à¸°à¸™à¹‰à¸³à¸à¸™ 
 
ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸£à¸„ 
- à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸•à¹‰à¸²à¸™à¸—à¸²à¸™ à¹€à¸Šà¹ˆà¸™ K88-92, Suphanburi 50
- à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸›à¸¥à¸¹à¸à¸­à¹‰à¸­à¸¢à¹à¸™à¹ˆà¸™à¹€à¸à¸´à¸™à¹„à¸› à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸­à¸²à¸à¸²à¸¨à¸–à¹ˆà¸²à¸¢à¹€à¸—  

ðŸ’Š à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ 
- à¹„à¸•à¸£à¸Ÿà¸­à¸à¸‹à¸µà¹ˆà¸ªà¹‚à¸•à¸£à¸šà¸´à¸™ (Trifloxystrobin) 
- à¹‚à¸žà¸£à¸žà¸´à¹€à¸™à¸š (Propineb)

ðŸŒ± à¸£à¸°à¸¢à¸°à¹à¸£à¸à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸­à¸‡à¹‚à¸£à¸„
- à¸žà¸šà¸­à¸²à¸à¸²à¸£à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡ à¸­à¹‰à¸­à¸¢à¸­à¸²à¸¢à¸¸ 2-3 à¹€à¸”à¸·à¸­à¸™  
- à¹€à¸£à¸´à¹ˆà¸¡à¸ˆà¸²à¸à¸ˆà¸¸à¸”à¹€à¸¥à¹‡à¸ à¹† à¸à¹ˆà¸­à¸™à¸‚à¸¢à¸²à¸¢à¹€à¸›à¹‡à¸™à¹à¸œà¸¥à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥  

ðŸ“ƒ à¹à¸«à¸¥à¹ˆà¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡:
- [à¸§à¸²à¸£à¸ªà¸²à¸£à¹€à¸à¸©à¸•à¸£à¸¨à¸²à¸ªà¸•à¸£à¹Œ](https://www.agri.kps.ku.ac.th)  
- [à¸‡à¸²à¸™à¸§à¸´à¸ˆà¸±à¸¢à¸‚à¸­à¸‡à¸¡à¸«à¸²à¸§à¸´à¸—à¸¢à¸²à¸¥à¸±à¸¢à¹€à¸à¸©à¸•à¸£à¸¨à¸²à¸ªà¸•à¸£à¹Œ](https://www.ku.ac.th)  
    """,
    "RedRot": """
ðŸŒ¿ à¹‚à¸£à¸„à¹€à¸«à¸µà¹ˆà¸¢à¸§à¹€à¸™à¹ˆà¸²à¹à¸”à¸‡ (Red Rot Disease)

âš ï¸ à¸­à¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¹‚à¸£à¸„
- à¹ƒà¸šà¹€à¸«à¸µà¹ˆà¸¢à¸§à¹à¸«à¹‰à¸‡ à¹à¸¥à¸°à¸¡à¸µà¸ªà¸µà¹€à¸«à¸¥à¸·à¸­à¸‡  
- à¸¥à¸³à¸•à¹‰à¸™à¸­à¹‰à¸­à¸¢à¸¡à¸µà¸£à¸­à¸¢à¹à¸•à¸ à¹à¸¥à¸°à¹€à¸™à¸·à¹‰à¸­à¹ƒà¸™à¹€à¸›à¹‡à¸™à¸ªà¸µà¹à¸”à¸‡-à¸”à¸³  
- à¸¡à¸µà¸à¸¥à¸´à¹ˆà¸™à¹€à¸™à¹ˆà¸²à¹€à¸«à¸¡à¹‡à¸™  

ðŸ”Ž à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹‚à¸£à¸„
- à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² Colletotrichum falcatum 
- à¹€à¸Šà¸·à¹‰à¸­à¹à¸žà¸£à¹ˆà¸à¸£à¸°à¸ˆà¸²à¸¢à¹ƒà¸™à¸”à¸´à¸™à¹à¸¥à¸°à¹€à¸‚à¹‰à¸²à¸—à¸³à¸¥à¸²à¸¢à¸—à¸²à¸‡à¸£à¸²à¸  

ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸£à¸„
- à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸—à¸™à¹‚à¸£à¸„ à¹€à¸Šà¹ˆà¸™ KPS94-13, U-Thong 2
- à¸›à¸¥à¸¹à¸à¸­à¹‰à¸­à¸¢à¸«à¸¡à¸¸à¸™à¹€à¸§à¸µà¸¢à¸™à¸à¸±à¸šà¸žà¸·à¸Šà¸­à¸·à¹ˆà¸™à¹€à¸žà¸·à¹ˆà¸­à¸¥à¸”à¸à¸²à¸£à¸ªà¸°à¸ªà¸¡à¸‚à¸­à¸‡à¹€à¸Šà¸·à¹‰à¸­  

ðŸ’Š à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰  
- à¹à¸¡à¸™à¹‚à¸„à¹€à¸‹à¸š (Mancozeb) 
- à¸„à¸²à¸£à¹Œà¹€à¸šà¸™à¸”à¸²à¸‹à¸´à¸¡ (Carbendazim) 

ðŸŒ± à¸£à¸°à¸¢à¸°à¹à¸£à¸à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸­à¸‡à¹‚à¸£à¸„ 
- à¸žà¸šà¸­à¸²à¸à¸²à¸£à¹ƒà¸™ à¸­à¹‰à¸­à¸¢à¸­à¸²à¸¢à¸¸ 3-5 à¹€à¸”à¸·à¸­à¸™ 
- à¹ƒà¸šà¹€à¸£à¸´à¹ˆà¸¡à¹€à¸«à¸µà¹ˆà¸¢à¸§à¹€à¸‰à¸² à¹à¸¥à¸°à¸¥à¸³à¸•à¹‰à¸™à¸­à¹‰à¸­à¸¢à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸›à¹‡à¸™à¸£à¸­à¸¢à¹à¸•à¸  

ðŸ“ƒ à¹à¸«à¸¥à¹ˆà¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡: 
- [à¸à¸£à¸¡à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¹€à¸à¸©à¸•à¸£](https://www.doa.go.th)  
- [IRRI (International Rice Research Institute)](https://www.irri.org)  
    """,
    "Yellow": """
ðŸŒ¿ à¹‚à¸£à¸„à¹ƒà¸šà¹„à¸«à¸¡à¹‰ (Leaf Scald Disease)

âš ï¸ à¸­à¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¹‚à¸£à¸„ 
- à¹ƒà¸šà¸¡à¸µà¸£à¸­à¸¢à¹„à¸«à¸¡à¹‰à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸¢à¸²à¸§à¸„à¸¥à¹‰à¸²à¸¢à¸–à¸¹à¸à¸™à¹‰à¸³à¸£à¹‰à¸­à¸™à¸¥à¸§à¸  
- à¸­à¹‰à¸­à¸¢à¹€à¸ˆà¸£à¸´à¸à¹€à¸•à¸´à¸šà¹‚à¸•à¸Šà¹‰à¸² à¹à¸¥à¸°à¸­à¸²à¸ˆà¸•à¸²à¸¢à¸•à¹‰à¸™  

ðŸ”Ž à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹‚à¸£à¸„
- à¹€à¸à¸´à¸”à¸ˆà¸²à¸à¹€à¸Šà¸·à¹‰à¸­à¹à¸šà¸„à¸—à¸µà¹€à¸£à¸µà¸¢ Xanthomonas albilineans
- à¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¹ˆà¸²à¸™à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¹à¸¥à¸°à¹à¸¡à¸¥à¸‡à¸žà¸²à¸«à¸°  

ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸£à¸„ 
- à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸—à¸™à¸—à¸²à¸™ à¹€à¸Šà¹ˆà¸™ **Suphanburi 7**  
- à¹à¸Šà¹ˆà¸—à¹ˆà¸­à¸™à¸žà¸±à¸™à¸˜à¸¸à¹Œà¹ƒà¸™à¸™à¹‰à¸³à¸£à¹‰à¸­à¸™ 50Â°C à¸™à¸²à¸™ 30 à¸™à¸²à¸—à¸µ à¹€à¸žà¸·à¹ˆà¸­à¸¥à¸”à¹€à¸Šà¸·à¹‰à¸­  

ðŸ’Š à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰ 
- à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸£à¸±à¸à¸©à¸²à¹‚à¸”à¸¢à¸•à¸£à¸‡ à¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¹à¸›à¸¥à¸‡à¹à¸—à¸™  

ðŸŒ± à¸£à¸°à¸¢à¸°à¹à¸£à¸à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸­à¸‡à¹‚à¸£à¸„ 
- à¸žà¸šà¸­à¸²à¸à¸²à¸£à¹€à¸¡à¸·à¹ˆà¸­à¸­à¹‰à¸­à¸¢à¹€à¸£à¸´à¹ˆà¸¡à¹à¸•à¸à¹ƒà¸šà¹ƒà¸«à¸¡à¹ˆ  
- à¹ƒà¸šà¸¡à¸µà¸£à¸­à¸¢à¸‹à¸µà¸”à¸‚à¸²à¸§à¸à¹ˆà¸­à¸™à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¹„à¸«à¸¡à¹‰  

ðŸ“ƒ à¹à¸«à¸¥à¹ˆà¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡: 
- [à¸à¸£à¸¡à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¹€à¸à¸©à¸•à¸£](https://www.doa.go.th)  
- [FAO (Food and Agriculture Organization)](https://www.fao.org)  
    """,
    "Unknown": """
âš ï¸ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸£à¸°à¸šà¸¸à¹‚à¸£à¸„à¹„à¸”à¹‰
à¸ªà¸²à¹€à¸«à¸•à¸¸à¸­à¸²à¸ˆà¹€à¸à¸´à¸”à¸ˆà¸²à¸:
1. à¸ à¸²à¸žà¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹ƒà¸šà¸­à¹‰à¸­à¸¢
2. à¹‚à¸£à¸„à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸™à¸£à¸°à¸šà¸š
3. à¸ à¸²à¸žà¸–à¹ˆà¸²à¸¢à¹„à¸¡à¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™

à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡à¸ à¸²à¸žà¹ƒà¸šà¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸²à¸à¸²à¸£à¸Šà¸±à¸”à¹€à¸ˆà¸™
à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸ à¸²à¸žà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡:
- à¸ à¸²à¸žà¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹€à¸”à¸µà¹ˆà¸¢à¸§à¹ƒà¸™à¹à¸ªà¸‡à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´
- à¸ à¸²à¸žà¹à¸ªà¸”à¸‡à¸­à¸²à¸à¸²à¸£à¹‚à¸£à¸„à¸Šà¸±à¸”à¹€à¸ˆà¸™
- à¸ à¸²à¸žà¸„à¸§à¸²à¸¡à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸ªà¸¹à¸‡à¸à¸§à¹ˆà¸² 300x300 à¸žà¸´à¸à¹€à¸‹à¸¥
    """
}
# à¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸„à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£
disease_display_names = {
    "Healthy": "à¸­à¹‰à¸­à¸¢à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸”à¸µ",
    "Mosaic": "à¹‚à¸£à¸„à¹ƒà¸šà¸”à¹ˆà¸²à¸‡à¸­à¹‰à¸­à¸¢",
    "Rust": "à¹‚à¸£à¸„à¸£à¸²à¸ªà¸™à¸´à¸¡",
    "RedRot": "à¹‚à¸£à¸„à¹€à¸«à¸µà¹ˆà¸¢à¸§à¹€à¸™à¹ˆà¸²à¹à¸”à¸‡",
    "Yellow": "à¹‚à¸£à¸„à¹ƒà¸šà¹„à¸«à¸¡à¹‰",
    "Unknown": "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¹‚à¸£à¸„"
}

app = FastAPI()
session = aiohttp.ClientSession()
line_bot_api = AsyncLineBotApi(channel_access_token, AiohttpAsyncHttpClient(session))
parser = WebhookParser(channel_secret)

# à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² LabelEncoder
label_encoder = LabelEncoder()
label_encoder.classes_ = np.array(["Healthy", "Mosaic", "RedRot", "Rust", "Yellow", "Unknown"])
def remove_background(img):
    """à¸•à¸±à¸”à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹à¸¥à¸°à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸ªà¸µà¸”à¸³"""
    try:
        # Convert to HSV
        hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)
        
        # à¸à¸³à¸«à¸™à¸”à¸Šà¹ˆà¸§à¸‡à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸‚à¸­à¸‡à¹ƒà¸šà¸­à¹‰à¸­à¸¢
        lower_green = np.array([25, 40, 40])
        upper_green = np.array([95, 255, 255])
        
        # à¸ªà¸£à¹‰à¸²à¸‡ mask à¸”à¹‰à¸§à¸¢ inRange
        mask = cv2.inRange(hsv, lower_green, upper_green)
        
        # à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡ mask à¸”à¹‰à¸§à¸¢ morphological operations
        kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (7,7))
        mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel, iterations=2)
        mask = cv2.morphologyEx(mask, cv2.MORPH_OPEN, kernel, iterations=1)
        
        # à¸«à¸² contour à¸—à¸µà¹ˆà¹ƒà¸«à¸à¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸”
        contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
        if contours:
            largest_contour = max(contours, key=cv2.contourArea)
            cv2.drawContours(mask, [largest_contour], -1, 255, thickness=cv2.FILLED)
        
        # à¸ªà¸£à¹‰à¸²à¸‡à¸ à¸²à¸žà¹ƒà¸«à¸¡à¹ˆà¹‚à¸”à¸¢à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¹€à¸›à¹‡à¸™à¸ªà¸µà¸”à¸³
        result = img.copy()
        result[mask == 0] = [0, 0, 0]  # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¹€à¸›à¹‡à¸™à¸ªà¸µà¸”à¸³
        
        return result, mask
    except Exception as e:
        logging.error(f"Background removal error: {e}")
        return img, None
def check_image_characteristics(img):
    """à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸žà¸·à¹‰à¸™à¸à¸²à¸™à¸‚à¸­à¸‡à¸ à¸²à¸ž (à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹ƒà¸«à¸¡à¹ˆ)"""
    try:
        # à¸•à¸±à¸”à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¹à¸¥à¸°à¸£à¸±à¸š mask
        _, mask = remove_background(img)
        
        if mask is None:
            return False
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§
        green_pixels = cv2.countNonZero(mask)
        green_ratio = green_pixels / (img.shape[0] * img.shape[1])
        
        return green_ratio > 0.2
    except Exception as e:
        logging.error(f"Image check error: {e}")
        return False

def preprocess_image(image_data):
    """à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸²à¸£à¸žà¸£à¸µà¹‚à¸žà¸£à¹€à¸‹à¸ªà¸ à¸²à¸ž (à¹€à¸žà¸´à¹ˆà¸¡à¸à¸²à¸£à¸•à¸±à¸”à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡)"""
    try:
        nparr = np.frombuffer(image_data, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        
        # à¸•à¸±à¸”à¸žà¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
        img_processed, _ = remove_background(img)
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸ à¸²à¸ž
        if not check_image_characteristics(img_processed):
            return None, "à¸ à¸²à¸žà¹„à¸¡à¹ˆà¸•à¸£à¸‡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ"

        # à¸›à¸£à¸±à¸šà¸‚à¸™à¸²à¸”à¹à¸¥à¸°à¸ªà¸µ
        img_processed = cv2.cvtColor(img_processed, cv2.COLOR_BGR2RGB)
        img_processed = cv2.resize(img_processed, (244, 244))
        return np.expand_dims(img_processed, axis=0), None
    except Exception as e:
        logging.error(f"Preprocessing error: {e}")
        return None, "à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸ à¸²à¸ž"

def calculate_ood_score(predictions):
    """à¸„à¸³à¸™à¸§à¸“à¸„à¸°à¹à¸™à¸™ Out-of-Distribution"""
    epsilon = 1e-10
    entropy = -np.sum(predictions * np.log(predictions + epsilon))
    return entropy

def preprocess_image(image_data):
    """à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸à¸²à¸£à¸žà¸£à¸µà¹‚à¸žà¸£à¹€à¸‹à¸ªà¸ à¸²à¸ž"""
    try:
        nparr = np.frombuffer(image_data, np.uint8)
        img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸¸à¸“à¸ªà¸¡à¸šà¸±à¸•à¸´à¸ à¸²à¸ž
        if not check_image_characteristics(img):
            return None, "à¸ à¸²à¸žà¹„à¸¡à¹ˆà¸•à¸£à¸‡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œ"

        # à¸›à¸£à¸±à¸šà¸‚à¸™à¸²à¸”à¹à¸¥à¸°à¸ªà¸µ
        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        img = cv2.resize(img, (224, 224))
        return np.expand_dims(img, axis=0), None
    except Exception as e:
        logging.error(f"Preprocessing error: {e}")
        return None, "à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¸ à¸²à¸ž"

async def classify_image(image_data):
    """à¸à¸£à¸°à¸šà¸§à¸™à¸à¸²à¸£à¸ˆà¸³à¹à¸™à¸à¸ à¸²à¸žà¹à¸šà¸šà¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡"""
    try:
        # à¸žà¸£à¸µà¹‚à¸žà¸£à¹€à¸‹à¸ªà¹à¸¥à¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ à¸²à¸ž
        processed_image, error_msg = preprocess_image(image_data)
        if error_msg:
            return error_msg

        # à¸—à¸³à¸™à¸²à¸¢à¸œà¸¥
        prediction = model.predict(processed_image)[0]
        
        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š OOD
        ood_score = calculate_ood_score(prediction)
        if ood_score > 1.2:
            return disease_info["Unknown"]

        # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸¡à¸±à¹ˆà¸™à¹ƒà¸ˆ
        confidence = np.max(prediction) * 100
        if confidence < 65:
            return disease_info["Unknown"]

        # à¸£à¸°à¸šà¸¸à¸„à¸¥à¸²à¸ª
        predicted_class = np.argmax(prediction)
        disease_name = label_encoder.inverse_transform([predicted_class])[0]

        return (
            f"à¸œà¸¥à¸à¸²à¸£à¸§à¸´à¸™à¸´à¸ˆà¸‰à¸±à¸¢: {disease_name}\n"
            f"à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³: {confidence:.2f}%\n\n"
            f"{disease_info.get(disease_name, disease_info['Unknown'])}"
        )
    except Exception as e:
        logging.error(f"Classification error: {e}")
        return disease_info["Unknown"]
@app.post("/callback")
async def handle_callback(request: Request):
    signature = request.headers.get('X-Line-Signature', '')
    body = await request.body()
    
    try:
        events = parser.parse(body.decode(), signature)
    except InvalidSignatureError:
        raise HTTPException(status_code=400, detail="Invalid signature")

    for event in events:
        if not isinstance(event, MessageEvent):
            continue
 
        elif event.message.type == "text":
            msg = event.message.text
            
            # à¸à¸£à¸“à¸µà¸—à¸±à¸à¸—à¸²à¸¢
            if msg.strip() == "à¸ªà¸§à¸±à¸ªà¸”à¸µ":
                response = "à¸™à¹‰à¸­à¸‡à¸­à¹‰à¸­à¸¢à¹ƒà¸ˆà¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸žà¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹€à¸žà¸·à¹ˆà¸­à¸—à¸³à¸™à¸²à¸¢à¹‚à¸£à¸„à¸«à¸£à¸·à¸­à¸ªà¹ˆà¸‡à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¸¡à¸²à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°"
            
            # à¸à¸£à¸“à¸µà¸ªà¸­à¸šà¸–à¸²à¸¡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¹‚à¸£à¸„
            elif any(kw in msg for kw in ["à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡", "à¸¡à¸µà¹‚à¸£à¸„à¸­à¸°à¹„à¸£", "à¹‚à¸£à¸„à¸¡à¸µà¸­à¸°à¹„à¸£", "à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢","à¸¡à¸µà¹‚à¸£à¸„à¹„à¸£à¸šà¹‰à¸²à¸‡""à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢à¹ƒà¸™à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢", 
             "à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢", "à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¸­à¹ˆà¸­à¸¢", "à¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„", "à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹‚à¸£à¸„", "à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸­à¸±à¸™à¸•à¸£à¸²à¸¢", 
            "à¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¸¡à¸µà¸à¸µà¹ˆà¹‚à¸£à¸„", "à¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡", "à¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸­à¸°à¹„à¸£", "à¹‚à¸£à¸„à¸—à¸µà¹ˆà¸žà¸šà¸šà¹ˆà¸­à¸¢à¹ƒà¸™à¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¸—à¸µà¹ˆà¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¹„à¸”à¹‰", 
            "à¹‚à¸£à¸„à¸‚à¸­à¸‡à¸­à¹‰à¸­à¸¢à¸¡à¸µà¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡", "à¸­à¹‰à¸­à¸¢à¸›à¹ˆà¸§à¸¢à¹€à¸›à¹‡à¸™à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡", "à¹‚à¸£à¸„à¸žà¸·à¸Šà¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¸žà¸·à¸Šà¹ƒà¸™à¸­à¹‰à¸­à¸¢", "à¸­à¹‰à¸­à¸¢à¸¡à¸µà¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡", 
            "à¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¹„à¸”à¹‰", "à¸­à¹‰à¸­à¸¢à¹€à¸à¸´à¸”à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡", "à¸­à¹‰à¸­à¸¢à¸¡à¸µà¸›à¸±à¸à¸«à¸²à¸ªà¸¸à¸‚à¸ à¸²à¸žà¸­à¸°à¹„à¸£", "à¸­à¹‰à¸­à¸¢à¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢à¸ˆà¸²à¸à¹‚à¸£à¸„à¸­à¸°à¹„à¸£", 
            "à¹‚à¸£à¸„à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¸à¸±à¸šà¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¸—à¸µà¹ˆà¸žà¸šà¹ƒà¸™à¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸­à¹‰à¸­à¸¢", "à¹‚à¸£à¸„à¸ªà¸³à¸„à¸±à¸à¹ƒà¸™à¸­à¹‰à¸­à¸¢", "à¸›à¸±à¸à¸«à¸²à¹‚à¸£à¸„à¹ƒà¸™à¸­à¹‰à¸­à¸¢", 
            "à¹‚à¸£à¸„à¸—à¸µà¹ˆà¸—à¸³à¹ƒà¸«à¹‰à¸­à¹‰à¸­à¸¢à¸•à¸²à¸¢", "à¸­à¹‰à¸­à¸¢à¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¸–à¸¶à¸‡à¸•à¸²à¸¢", "à¹‚à¸£à¸„à¹ƒà¸™à¸­à¹‰à¸­à¸¢à¸¡à¸µà¸­à¸°à¹„à¸£à¸—à¸µà¹ˆà¸£à¹‰à¸²à¸¢à¹à¸£à¸‡", "à¸­à¹‰à¸­à¸¢à¹€à¸ˆà¸­à¹‚à¸£à¸„à¸­à¸°à¹„à¸£à¹„à¸”à¹‰à¸šà¹‰à¸²à¸‡"]):
                diseases = [disease_display_names[d] for d in disease_info.keys() if d != "Unknown"]
                disease_list = "\n- ".join(diseases)
                response = f"ðŸ“œ à¹‚à¸£à¸„à¹ƒà¸™à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹„à¸”à¹‰à¸¡à¸µà¸”à¸±à¸‡à¸™à¸µà¹‰:\n- {disease_list}\n\nðŸ–¼ï¸ à¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸ à¸²à¸žà¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹€à¸žà¸·à¹ˆà¸­à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹‚à¸£à¸„à¹„à¸”à¹‰à¸„à¹ˆà¸°"
             # à¸à¸£à¸“à¸µà¸žà¸¹à¸”à¸–à¸¶à¸‡à¹‚à¸£à¸„à¸«à¸£à¸·à¸­à¸­à¹‰à¸­à¸¢à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
            elif any(kw in msg for kw in ["à¹ƒà¸šà¸”à¹ˆà¸²à¸‡à¸­à¹‰à¸­à¸¢","à¹‚à¸£à¸„à¹ƒà¸šà¸”à¹ˆà¸²à¸‡","Mosaic","mosaic","à¹ƒà¸šà¸”à¹ˆà¸²à¸‡","à¸”à¹ˆà¸²à¸‡","à¹‚à¸£à¸„à¹ƒà¸šà¸”à¹ˆà¸²à¸‡à¸­à¹‰à¸­à¸¢"]):
                response = "à¸£à¸§à¸¡à¸„à¸³à¸•à¸­à¸šà¹‚à¸£à¸„à¹ƒà¸šà¸”à¹ˆà¸²à¸‡à¸­à¹‰à¸­à¸¢(Mosaic)à¹ƒà¸«à¹‰à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸°" \
                            "âš ï¸ à¸­à¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¹‚à¸£à¸„" \
                            "- à¹ƒà¸šà¸­à¹‰à¸­à¸¢à¸¡à¸µà¸¥à¸²à¸¢à¸”à¹ˆà¸²à¸‡à¸ªà¸µà¹€à¸‚à¸µà¸¢à¸§à¸­à¹ˆà¸­à¸™à¸ªà¸¥à¸±à¸šà¹€à¸‚à¸µà¸¢à¸§à¹€à¸‚à¹‰à¸¡à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡" \
                            "- à¹ƒà¸šà¸­à¸²à¸ˆà¸šà¸´à¸”à¹€à¸šà¸µà¹‰à¸¢à¸§à¸«à¸£à¸·à¸­à¹€à¸ˆà¸£à¸´à¸à¹€à¸•à¸´à¸šà¹‚à¸•à¸Šà¹‰à¸²à¸à¸§à¹ˆà¸²à¸›à¸à¸•à¸´  " \
                            "- à¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹‚à¸£à¸„à¸£à¸¸à¸™à¹à¸£à¸‡à¸­à¸²à¸ˆà¹à¸„à¸£à¸°à¹à¸à¸£à¹‡à¸™ à¹à¸¥à¸°à¹ƒà¸«à¹‰à¸œà¸¥à¸œà¸¥à¸´à¸•à¸•à¹ˆà¸³  " \
                            "ðŸ”Ž à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸à¸´à¸”à¹‚à¸£à¸„ " \
                            "- à¹€à¸à¸´à¸”à¸ˆà¸²à¸ à¹€à¸Šà¸·à¹‰à¸­à¹„à¸§à¸£à¸±à¸ª Sugarcane Mosaic Virus (SCMV)" \
                            "- à¸•à¸´à¸”à¸•à¹ˆà¸­à¸œà¹ˆà¸²à¸™ à¹€à¸žà¸¥à¸µà¹‰à¸¢à¸­à¹ˆà¸­à¸™ (Aphids) à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸žà¸²à¸«à¸°  " \
                            "- à¹à¸žà¸£à¹ˆà¸à¸£à¸°à¸ˆà¸²à¸¢à¸œà¹ˆà¸²à¸™à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸—à¸µà¹ˆà¸•à¸´à¸”à¹€à¸Šà¸·à¹‰à¸­  " \
                            "ðŸ›¡ï¸ à¸§à¸´à¸˜à¸µà¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¹‚à¸£à¸„  " \
                            "- à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸•à¹‰à¸²à¸™à¸—à¸²à¸™à¹‚à¸£à¸„ à¹€à¸Šà¹ˆà¸™ KK3, LK92-11 " \
                            "- à¸„à¸§à¸šà¸„à¸¸à¸¡à¹€à¸žà¸¥à¸µà¹‰à¸¢à¸­à¹ˆà¸­à¸™à¹‚à¸”à¸¢à¹ƒà¸Šà¹‰à¸ªà¸²à¸£à¸Šà¸µà¸§à¸ à¸±à¸“à¸‘à¹Œ  " \
                            "- à¸«à¸¥à¸µà¸à¹€à¸¥à¸µà¹ˆà¸¢à¸‡à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸žà¸±à¸™à¸˜à¸¸à¹Œà¸­à¹‰à¸­à¸¢à¸ˆà¸²à¸à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸µà¹‚à¸£à¸„à¸£à¸°à¸šà¸²à¸”  " \
                            "ðŸ’Š à¸ªà¸²à¸£à¹€à¸„à¸¡à¸µà¸—à¸µà¹ˆà¹ƒà¸Šà¹‰" \
                            "- à¸­à¸´à¸¡à¸´à¸”à¸²à¸„à¸¥à¸­à¸žà¸£à¸´à¸” (Imidacloprid)" \
                            "- à¹€à¸Šà¸·à¹‰à¸­à¸£à¸² Beauveria bassiana  " \
                            "ðŸŒ± à¸£à¸°à¸¢à¸°à¹à¸£à¸à¹€à¸£à¸´à¹ˆà¸¡à¸‚à¸­à¸‡à¹‚à¸£à¸„" \
                            "- à¸žà¸šà¸­à¸²à¸à¸²à¸£à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡ à¸•à¹‰à¸™à¸­à¹‰à¸­à¸¢à¸­à¸²à¸¢à¸¸ 1-2 à¹€à¸”à¸·à¸­à¸™" \
                            "- à¹ƒà¸šà¹€à¸£à¸´à¹ˆà¸¡à¸¡à¸µà¸ˆà¸¸à¸”à¸”à¹ˆà¸²à¸‡à¹€à¸›à¹‡à¸™à¹à¸–à¸šà¸„à¸¥à¹‰à¸²à¸¢à¸¥à¸²à¸¢à¹‚à¸¡à¹€à¸ªà¸„  " \
                            "ðŸ“ƒ à¹à¸«à¸¥à¹ˆà¸‡à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡:" \
                            "- [à¸à¸£à¸¡à¸§à¸´à¸Šà¸²à¸à¸²à¸£à¹€à¸à¸©à¸•à¸£](https://www.doa.go.th)  " \
                            "- [à¸§à¸²à¸£à¸ªà¸²à¸£à¹‚à¸£à¸„à¸žà¸·à¸Šà¹à¸¥à¸°à¸ˆà¸¸à¸¥à¸Šà¸µà¸§à¸§à¸´à¸—à¸¢à¸²](https://www.tjpp.org)"

            # à¸à¸£à¸“à¸µà¸žà¸¹à¸”à¸–à¸¶à¸‡à¹‚à¸£à¸„à¸«à¸£à¸·à¸­à¸­à¹‰à¸­à¸¢à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”
            elif any(kw in msg for kw in ["à¹‚à¸£à¸„", "à¸­à¹‰à¸­à¸¢"]):
                response = "à¸à¸£à¸¸à¸“à¸²à¸ªà¹ˆà¸‡à¸ à¸²à¸žà¹ƒà¸šà¸­à¹‰à¸­à¸¢à¹€à¸žà¸·à¹ˆà¸­à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹‚à¸£à¸„"
            
            # à¸à¸£à¸“à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›
            else:
                response = "à¸£à¸°à¸šà¸šà¸™à¸µà¹‰à¹ƒà¸Šà¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹‚à¸£à¸„à¸­à¹‰à¸­à¸¢à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™"
            
            await line_bot_api.reply_message(
                event.reply_token,
                TextSendMessage(text=response))
        elif event.message.type == "image":
            try:
                message_content = await line_bot_api.get_message_content(event.message.id)
                image_data = b''
                
                async for chunk in message_content.iter_content():
                    image_data += chunk

                result = await classify_image(image_data)
                
                await line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=result))
                
            except Exception as e:
                logging.error(f"Image processing error: {e}")
                await line_bot_api.reply_message(
                    event.reply_token,
                    TextSendMessage(text=disease_info["Unknown"]))
    return {"status": "success"}
